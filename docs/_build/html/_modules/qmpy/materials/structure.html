<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>qmpy.materials.structure &mdash; qmpy 0.4.9 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.4.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="qmpy 0.4.9 documentation" href="../../../index.html" />
    <link rel="up" title="qmpy" href="../../qmpy.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">qmpy 0.4.9 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../qmpy.html" accesskey="U">qmpy</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for qmpy.materials.structure</h1><div class="highlight"><pre>
<span class="c"># qmpy/materials/structure.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The Structure class is used to represent a crystal structure.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.linalg</span> <span class="kn">as</span> <span class="nn">la</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span>

<span class="kn">import</span> <span class="nn">qmpy</span>
<span class="kn">from</span> <span class="nn">qmpy.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">element</span> <span class="kn">import</span> <span class="n">Element</span><span class="p">,</span> <span class="n">Species</span>
<span class="kn">from</span> <span class="nn">atom</span> <span class="kn">import</span> <span class="n">Atom</span><span class="p">,</span> <span class="n">Site</span>
<span class="kn">from</span> <span class="nn">composition</span> <span class="kn">import</span> <span class="n">Composition</span>
<span class="kn">from</span> <span class="nn">qmpy.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">qmpy.data.meta_data</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">qmpy.analysis.symmetry</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">qmpy.analysis</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">StructureError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Structure related problem&quot;&quot;&quot;</span>

<span class="nd">@add_meta_data</span><span class="p">(</span><span class="s">&#39;comment&#39;</span><span class="p">)</span>
<span class="nd">@add_meta_data</span><span class="p">(</span><span class="s">&#39;keyword&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="Structure"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure">[docs]</a><span class="k">class</span> <span class="nc">Structure</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Structure model. Principal attributes are a lattice and basis set.</span>

<span class="sd">    Relationships:</span>
<span class="sd">        | :mod:`~qmpy.Entry` via entry</span>
<span class="sd">        | :mod:`~qmpy.Atom` via atom_set: Atoms in the structure. More commonly</span>
<span class="sd">        |   handled by the managed attributed `atoms`.</span>
<span class="sd">        | :mod:`~qmpy.Site` via site_set</span>
<span class="sd">        | :mod:`~qmpy.Calculation` via calculated. Calculation objects</span>
<span class="sd">        |   that the structure is an *output* from.</span>
<span class="sd">        | :mod:`~qmpy.Calculation` via calculation_set. Returns calculation</span>
<span class="sd">        |   objects that the structure is an *input* to.</span>
<span class="sd">        | :mod:`~qmpy.Composition` via composition.</span>
<span class="sd">        | :mod:`~qmpy.Element` via element_set</span>
<span class="sd">        | :mod:`~qmpy.Spacegroup` via spacegroup</span>
<span class="sd">        | :mod:`~qmpy.Species` via species_set</span>
<span class="sd">        | :mod:`~qmpy.Prototype` via prototype. If the structure belongs to a</span>
<span class="sd">        |   prototypical structure, it is referred to here.</span>
<span class="sd">        | :mod:`~qmpy.Reference` Original literature reference.</span>
<span class="sd">        | :mod:`~qmpy.MetaData` via meta_data</span>

<span class="sd">    Attributes:</span>
<span class="sd">        | **Identification**</span>
<span class="sd">        | id</span>
<span class="sd">        | label: key in the Entry.structures dictionary.</span>
<span class="sd">        | natoms: Number of atoms.</span>
<span class="sd">        | nsites: Number of sites.</span>
<span class="sd">        | ntypes: Number of elements.</span>
<span class="sd">        | measured: Experimentally measured structure?</span>
<span class="sd">        | source: Name for source.</span>
<span class="sd">        | </span>
<span class="sd">        | **Lattice**</span>
<span class="sd">        | x1, x2, x3</span>
<span class="sd">        | y1, y2, y3</span>
<span class="sd">        | z1, z2, z3: Lattice vectors of the cell. Accessed via `cell`.</span>
<span class="sd">        | volume</span>
<span class="sd">        | volume_pa</span>
<span class="sd">        |</span>
<span class="sd">        | **Calculated properties**</span>
<span class="sd">        | delta_e: Formation energy (eV/atom)</span>
<span class="sd">        | meta_stability: Distance from the convex hull (eV/atom)</span>
<span class="sd">        | energy: Total DFT energy (eV/FU)</span>
<span class="sd">        | energy_pa: Total DFT energy (eV/atom)</span>
<span class="sd">        | magmom: Total magnetic moment (&amp;Mu;&lt;sub&gt;b&lt;/sub&gt;)</span>
<span class="sd">        | magmom_pa: Magnetic moment per atom.</span>
<span class="sd">        | sxx, sxy, syy</span>
<span class="sd">        | syx, szx, szz: Stresses on the cell. Accessed via `stresses`.</span>

<span class="sd">    Examples:</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; s = io.read(INSTALL_PATH+&#39;/io/files/POSCAR_FCC&#39;)</span>
<span class="sd">        &gt;&gt;&gt; s.atoms</span>
<span class="sd">        &gt;&gt;&gt; s.cell</span>
<span class="sd">        &gt;&gt;&gt; s.magmoms</span>
<span class="sd">        &gt;&gt;&gt; s.forces</span>
<span class="sd">        &gt;&gt;&gt; s.stresses</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;Entry&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">element_set</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s">&#39;Element&#39;</span><span class="p">)</span>
    <span class="n">species_set</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s">&#39;Species&#39;</span><span class="p">)</span>
    <span class="n">meta_data</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s">&#39;MetaData&#39;</span><span class="p">)</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;Reference&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">63</span><span class="p">)</span>
    <span class="n">prototype</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;Prototype&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                               <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;+&#39;</span><span class="p">)</span>
    <span class="n">measured</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">composition</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;Composition&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                                    <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;structure_set&#39;</span><span class="p">)</span>
    <span class="n">natoms</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">nsites</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ntypes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">x1</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">x3</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">y3</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="n">z3</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>

    <span class="n">volume</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">volume_pa</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">sxx</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">syy</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">szz</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">sxy</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">syz</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">szx</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">spacegroup</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;Spacegroup&#39;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">energy</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">energy_pa</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">magmom</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">magmom_pa</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">delta_e</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">meta_stability</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">_reciprocal_lattice</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_distinct_atoms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_magmoms</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">app_label</span> <span class="o">=</span> <span class="s">&#39;qmpy&#39;</span>
        <span class="n">db_table</span> <span class="o">=</span> <span class="s">&#39;structures&#39;</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">format_comp</span><span class="p">(</span><span class="n">reduce_comp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Structure.create"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="p">[],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a new Structure.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            cell: 3x3 lattice vector array</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            atoms: List of ``Atom`` creation arguments. Can be a list of </span>
<span class="sd">            [element, coord], or a list of [element, coord, kwargs].</span>

<span class="sd">        Examples::</span>

<span class="sd">            &gt;&gt;&gt; a = 3.54</span>
<span class="sd">            &gt;&gt;&gt; cell = [[a,0,0],[0,a,0],[0,0,a]]</span>
<span class="sd">            &gt;&gt;&gt; atoms = [(&#39;Cu&#39;, [0,0,0]),</span>
<span class="sd">                         (&#39;Cu&#39;, [0.5, 0.5, 0.5])]</span>
<span class="sd">            &gt;&gt;&gt; s = Structure.create(cell, atoms)</span>
<span class="sd">            &gt;&gt;&gt; atoms = [(&#39;Cu&#39;, [0,0,0], {&#39;magmom&#39;:3}),</span>
<span class="sd">                    (&#39;Cu&#39;, [0.5, 0.5, 0.5], {&#39;magmom&#39;:-3})]</span>
<span class="sd">            &gt;&gt;&gt; s2 = Structure.create(cell, atoms)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">lat_params</span> <span class="o">=</span> <span class="n">cell</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">cell</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">cell</span>

        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">*</span><span class="n">atom</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">atom</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">atom</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">atom</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">s</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="c">#@transaction.atomic</span></div>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">=</span> <span class="n">Composition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacegroup</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Structure</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="n">a</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="n">a</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c">#self.atom_set = self.atoms</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
                <span class="n">s</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="n">s</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c">#self.site_set = self.sites</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment_objects</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyword_objects</span>

    <span class="n">_atoms</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of ``Atoms`` in the structure. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span>

    <span class="nd">@atoms.setter</span>
<div class="viewcode-block" id="Structure.atoms"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.atoms">[docs]</a>    <span class="k">def</span> <span class="nf">atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span> <span class="o">=</span> <span class="n">atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span>
</div>
    <span class="n">_sites</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sites</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of ``Sites`` in the structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sites</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span>

    <span class="nd">@sites.setter</span>
<div class="viewcode-block" id="Structure.sites"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.sites">[docs]</a>    <span class="k">def</span> <span class="nf">sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sites</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span> <span class="o">=</span> <span class="n">sites</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nsites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.elements"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.elements">[docs]</a>    <span class="k">def</span> <span class="nf">elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of Elements&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span> <span class="n">Element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">]</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.species"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.species">[docs]</a>    <span class="k">def</span> <span class="nf">species</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of species&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span> <span class="n">Species</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_comp</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">]</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stresses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculated stresses, a numpy.ndarray of shape (6,)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">sxx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">syy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">szz</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">syz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">szx</span> <span class="p">])</span>
        
    <span class="nd">@stresses.setter</span>
<div class="viewcode-block" id="Structure.stresses"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.stresses">[docs]</a>    <span class="k">def</span> <span class="nf">stresses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sxx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">syy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">szz</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sxy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">syz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">szx</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Structure.get_volume"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.get_volume">[docs]</a>    <span class="k">def</span> <span class="nf">get_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the volume from the triple product of self.cell&quot;&quot;&quot;</span>
        <span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">b3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">),</span> <span class="n">b3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume_pa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
</div>
<div class="viewcode-block" id="Structure.set_volume"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.set_volume">[docs]</a>    <span class="k">def</span> <span class="nf">set_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rescales the unit cell to the specified volume, keeping the direction</span>
<span class="sd">        and relative magnitudes of all lattice vectors the same.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">value</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">*</span> <span class="n">scale</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume_pa</span> <span class="o">=</span> <span class="n">value</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">value</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.lat_param_dict"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.lat_param_dict">[docs]</a>    <span class="k">def</span> <span class="nf">lat_param_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dictionary of lattice parameters.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">,</span> <span class="s">&#39;alpha&#39;</span><span class="p">,</span> <span class="s">&#39;beta&#39;</span><span class="p">,</span> <span class="s">&#39;gamma&#39;</span><span class="p">],</span> 
                         <span class="bp">self</span><span class="o">.</span><span class="n">lat_params</span><span class="p">))</span>
</div>
    <span class="n">_lat_params</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lat_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tuple of lattice parameters (a, b, c, alpha, beta, gamma).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lat_params</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_lat_params</span> <span class="o">=</span> <span class="n">basis_to_latparams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lat_params</span>

    <span class="nd">@lat_params.setter</span>
<div class="viewcode-block" id="Structure.lat_params"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.lat_params">[docs]</a>    <span class="k">def</span> <span class="nf">lat_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lat_params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">latparams_to_basis</span><span class="p">(</span><span class="n">lat_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lat_params</span> <span class="o">=</span> <span class="n">lat_params</span>
</div>
    <span class="n">lp</span> <span class="o">=</span> <span class="n">lat_params</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lattice vectors, 3x3 numpy.ndarray.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x3</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y3</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">z1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z3</span><span class="p">]])</span>

    <span class="nd">@cell.setter</span>
<div class="viewcode-block" id="Structure.cell"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.cell">[docs]</a>    <span class="k">def</span> <span class="nf">cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x3</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y3</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z3</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lat_params</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inv</span> <span class="o">=</span> <span class="bp">None</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metrical_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;np.dot(self.cell.T, self.cell)&quot;&quot;&quot;</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">A</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">Y</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">Z</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">X</span><span class="p">],</span>
                         <span class="p">[</span><span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">C</span><span class="p">]])</span>

    <span class="nd">@metrical_matrix.setter</span>
<div class="viewcode-block" id="Structure.metrical_matrix"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.metrical_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">metrical_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">G</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">al</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">c</span><span class="p">))</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">be</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="p">))</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">ga</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="p">))</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">latparams_to_basis</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">al</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">ga</span><span class="p">])</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.atomic_numbers"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.atomic_numbers">[docs]</a>    <span class="k">def</span> <span class="nf">atomic_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of atomic numbers, length equal to number of atoms.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">z</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="p">])</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">atom_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of atomic symbols, length equal to number of atoms.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">atom</span><span class="o">.</span><span class="n">element_id</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="p">])</span>

    <span class="nd">@atom_types.setter</span>
<div class="viewcode-block" id="Structure.atom_types"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.atom_types">[docs]</a>    <span class="k">def</span> <span class="nf">atom_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">elements</span><span class="p">):</span>
            <span class="n">a</span><span class="o">.</span><span class="n">element_id</span> <span class="o">=</span> <span class="n">e</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.species_types"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.species_types">[docs]</a>    <span class="k">def</span> <span class="nf">species_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of species, length equal to number of atoms.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">atom</span><span class="o">.</span><span class="n">species_id</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="p">])</span>
</div>
<div class="viewcode-block" id="Structure.symmetrize"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.symmetrize">[docs]</a>    <span class="k">def</span> <span class="nf">symmetrize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">angle_tol</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze the symmetry of the structure. Uses spglib to find the</span>
<span class="sd">        symmetry. </span>

<span class="sd">        symmetrize sets:</span>
<span class="sd">         * spacegroup -&gt; Spacegroup</span>
<span class="sd">         * uniq_sites -&gt; list of unique Sites</span>
<span class="sd">         * orbits -&gt; lists of equivalent Atoms</span>
<span class="sd">         * rotations -&gt; List of rotation operations</span>
<span class="sd">         * translations -&gt; List of translation operations</span>
<span class="sd">         * operatiosn -&gt; List of (rotation,translation) pairs</span>
<span class="sd">         * for each atom: atom.wyckoff -&gt; WyckoffSite</span>
<span class="sd">         * for each site: site.multiplicity -&gt; int</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_symmetry_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                       <span class="n">symprec</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacegroup</span> <span class="o">=</span> <span class="n">Spacegroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">dataset</span><span class="p">[</span><span class="s">&#39;number&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">):</span>    
            <span class="n">site</span><span class="o">.</span><span class="n">wyckoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spacegroup</span><span class="o">.</span><span class="n">get_site</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s">&#39;wyckoffs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="n">site</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">orbits</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="s">&#39;equivalent_atoms&#39;</span><span class="p">]:</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">orbits</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operations</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="s">&#39;rotations&#39;</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s">&#39;translations&#39;</span><span class="p">])</span>
        <span class="n">rots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="s">&#39;rotations&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rots</span> <span class="p">]):</span>
                <span class="n">rots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotations</span> <span class="o">=</span> <span class="n">rots</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="s">&#39;translations&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">trans</span> <span class="p">]):</span>
                <span class="n">trans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translations</span> <span class="o">=</span> <span class="n">trans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbits</span> <span class="o">=</span> <span class="n">orbits</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uniq_sites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">mult</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">site</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
            <span class="n">site</span><span class="o">.</span><span class="n">multiplicity</span> <span class="o">=</span> <span class="n">mult</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uniq_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Structure.pdf_compare"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.pdf_compare">[docs]</a>    <span class="k">def</span> <span class="nf">pdf_compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the PDF for each structure and evaluate the overlap integral</span>
<span class="sd">        for all pairs of species.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">elts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">element_id</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span> <span class="p">]))</span> 
        <span class="n">dists</span> <span class="o">=</span> <span class="n">get_pair_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">odists</span> <span class="o">=</span> <span class="n">get_pair_distances</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e1</span><span class="p">,</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">elts</span><span class="p">,</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="n">dists</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">([</span><span class="n">e1</span><span class="p">,</span><span class="n">e2</span><span class="p">])]</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">odists</span><span class="p">[</span><span class="nb">frozenset</span><span class="p">([</span><span class="n">e1</span><span class="p">,</span><span class="n">e2</span><span class="p">])]</span>
            <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Structure.compare"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Credit to K. Michel for the algorithm.</span>

<span class="sd">        1. Check that elements are the same in both structures</span>

<span class="sd">        2. Convert both structures to primitive form</span>

<span class="sd">        3. Check that the total number of atoms in primitive cells are the same</span>

<span class="sd">        4. Check that the number of atoms of each element are the same in</span>
<span class="sd">        primitive cells</span>

<span class="sd">        5. If needed check that the primitive cell volumes are the same</span>

<span class="sd">        6. Convert both primitive cells to reduced form There is one issue here - </span>
<span class="sd">        the reduce cell could be type I (all angles acute) or type II (all angles </span>
<span class="sd">        obtuse) and a slight difference in the initial cells could cause two </span>
<span class="sd">        structures to reduce to different types. So at this step, if the angles </span>
<span class="sd">        are not correct, the second cell is transformed as </span>
<span class="sd">        [[-1, 0, 0], [0, -1, 0], [0, 0, 1]].</span>

<span class="sd">        7. Check that the cell internal angles are the same in both reduced</span>
<span class="sd">        cells. </span>

<span class="sd">        8. Check that the ratios of reduced cell basis lengths are the same. ie</span>
<span class="sd">        a1/b1 = a2/b2, a1/c1 = a2/c2, and b1/c1 = b2/c2 where a1, b1, c1, are</span>
<span class="sd">        the lengths of basis vectors in cell 1 and a2, b2, c2 are the lengths</span>
<span class="sd">        of cell 2.</span>

<span class="sd">        9. Get the lattice symmetry of the reduced cell 2 (this is a list of</span>
<span class="sd">        all rotations that leave the lattice itself unchanged). In turn, apply</span>
<span class="sd">        all rotations to reduced cell 2 and for each search for a vector that</span>
<span class="sd">        overlaps rotated cell positions with positions in reduced cell 1. If a</span>
<span class="sd">        rotation + translation overlaps reduced cells, then they are the same.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            other: Another ``Structure``.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            tol: Percent deviation in lattice parameters and angles.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># 1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">elements</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Structure comparison: element mismatch&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_primitive</span><span class="p">()</span>
        <span class="n">other</span><span class="o">.</span><span class="n">make_primitive</span><span class="p">()</span>

        <span class="c"># 3</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">natoms</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Structure comparison: natom mismatch&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># 4</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">composition</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Structure comparison: composition mismatch&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># 5 (optional)</span>
        <span class="k">if</span> <span class="n">volume</span><span class="p">:</span>
            <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume</span><span class="p">(),</span> <span class="n">other</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v1</span> <span class="o">-</span> <span class="n">v2</span><span class="p">)</span><span class="o">/</span><span class="nb">min</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Structure comparison: volume mismatch&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># 6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">()</span>
        <span class="n">other</span><span class="o">.</span><span class="n">reduce</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">90</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_params</span><span class="p">[</span><span class="mi">3</span><span class="p">:]]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Structure comparison: converting self from type II to type I.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">90</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">lat_params</span><span class="p">[</span><span class="mi">3</span><span class="p">:]]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Structure comparison: converting other from type II to type I.&quot;</span><span class="p">)</span>
            <span class="n">other</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="c"># 7</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_params</span><span class="p">[</span><span class="mi">3</span><span class="p">:],</span> <span class="n">other</span><span class="o">.</span><span class="n">lat_params</span><span class="p">[</span><span class="mi">3</span><span class="p">:]):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">((</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Structure comparison: lat param mismatch&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># 8</span>
        <span class="n">ratios</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span><span class="o">/</span><span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lp</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">other</span><span class="o">.</span><span class="n">lp</span><span class="p">[:</span><span class="mi">3</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">ratios</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="nb">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Structure comparison: lattice vector ratio mismatch&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># breakout for large structures</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># 9</span>
        <span class="n">min_elt</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">[</span><span class="n">x</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotations</span><span class="p">:</span>
            <span class="c"># try mapping each atom onto other atoms of the same type</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">rot</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">a1</span><span class="o">.</span><span class="n">element_id</span> <span class="o">!=</span> <span class="n">min_elt</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">inv</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">coords</span> <span class="p">])</span>
                <span class="n">coords</span> <span class="o">%=</span> <span class="mf">1.0</span>
                <span class="n">coords</span> <span class="o">%=</span> <span class="mf">1.0</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">a1</span><span class="o">.</span><span class="n">species</span> <span class="o">!=</span> <span class="n">a2</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">a1</span><span class="o">.</span><span class="n">coord</span>
                    <span class="n">tcoords</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">-</span> <span class="n">t</span>
                    <span class="n">tcoords</span> <span class="o">%=</span> <span class="mf">1.0</span>
                    <span class="n">tcoords</span> <span class="o">%=</span> <span class="mf">1.0</span>
                    <span class="c"># check </span>
                    <span class="n">match</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                        <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">element_id</span><span class="p">,</span> <span class="n">tcoords</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">50</span><span class="o">*</span><span class="n">tol</span><span class="p">):</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="k">break</span>

                    <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Atoms don&#39;t match.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">element_id</span> <span class="o">==</span> <span class="n">b</span><span class="o">.</span><span class="n">element_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">ca</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">coord</span> <span class="p">]</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="p">[</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">coord</span> <span class="p">]</span>
            <span class="n">lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lat_params</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ca</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">cb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">lp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tol</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_distance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

<div class="viewcode-block" id="Structure.get_distance_squared"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.get_distance_squared">[docs]</a>    <span class="k">def</span> <span class="nf">get_distance_squared</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the shorted distance between two atoms in the structure.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">atom1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom1</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="p">(</span><span class="n">Atom</span><span class="p">,</span><span class="n">Site</span><span class="p">)):</span>
            <span class="n">atom1</span> <span class="o">=</span> <span class="n">atom1</span><span class="o">.</span><span class="n">coord</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom2</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom2</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom2</span><span class="p">,</span> <span class="p">(</span><span class="n">Atom</span><span class="p">,</span><span class="n">Site</span><span class="p">)):</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">coord</span>

        <span class="n">vec</span> <span class="o">=</span> <span class="n">atom1</span> <span class="o">-</span> <span class="n">atom2</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dist</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Structure.get_distance"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.get_distance">[docs]</a>    <span class="k">def</span> <span class="nf">get_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom1</span><span class="p">,</span> <span class="n">atom2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the shorted distance between two atoms in the structure.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">atom1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom1</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom1</span><span class="p">,</span> <span class="p">(</span><span class="n">Atom</span><span class="p">,</span><span class="n">Site</span><span class="p">)):</span>
            <span class="n">atom1</span> <span class="o">=</span> <span class="n">atom1</span><span class="o">.</span><span class="n">coord</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom2</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atom2</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom2</span><span class="p">,</span> <span class="p">(</span><span class="n">Atom</span><span class="p">,</span><span class="n">Site</span><span class="p">)):</span>
            <span class="n">atom2</span> <span class="o">=</span> <span class="n">atom2</span><span class="o">.</span><span class="n">coord</span>

        <span class="n">vec</span> <span class="o">=</span> <span class="n">atom1</span> <span class="o">-</span> <span class="n">atom2</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vec</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">vec</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">la</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">add_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacegroup</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_composition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">=</span> <span class="n">Composition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">composition</span>

<div class="viewcode-block" id="Structure.set_magnetism"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.set_magnetism">[docs]</a>    <span class="k">def</span> <span class="nf">set_magnetism</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="s">&#39;primitive&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assigns magnetic moments to all atoms in accordance with the specified</span>
<span class="sd">        magnetism scheme.</span>

<span class="sd">        Schemes:</span>

<span class="sd">        +---------+-------------------------------------+</span>
<span class="sd">        | Keyword | Description                         |</span>
<span class="sd">        +=========+=====================================+</span>
<span class="sd">        |  None   | all magnetic moments = None         |</span>
<span class="sd">        +---------+-------------------------------------+</span>
<span class="sd">        | &quot;ferro&quot; | atoms with partially filled d and   |</span>
<span class="sd">        |         | f shells are assigned a magnetic    |</span>
<span class="sd">        |         | moment of 5 mu_b                    |</span>
<span class="sd">        +---------+-------------------------------------+</span>
<span class="sd">        | &quot;anti&quot;  | finds a highly ordererd arrangement |</span>
<span class="sd">        |         | arrangement of up and down spins.   |</span>
<span class="sd">        |         | If only 1 magnetic atom is found    |</span>
<span class="sd">        |         | a ferromagnetic arrangment is used. |</span>
<span class="sd">        |         | raises NotImplementedError          |</span>
<span class="sd">        +---------+-------------------------------------+</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;none&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;ferro&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">d_elec</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">d_elec</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">f_elec</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">f_elec</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">:</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="mi">7</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s">&#39;anti-ferro&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spacegroup</span> <span class="o">=</span> <span class="bp">None</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.comp"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.comp">[docs]</a>    <span class="k">def</span> <span class="nf">comp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Composition dictionary.&quot;&quot;&quot;</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">elt</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">element_id</span>
            <span class="n">comp</span><span class="p">[</span><span class="n">elt</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">atom</span><span class="o">.</span><span class="n">occupancy</span>
        <span class="k">return</span> <span class="n">comp</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.spec_comp"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.spec_comp">[docs]</a>    <span class="k">def</span> <span class="nf">spec_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Species composition dictionary.&quot;&quot;&quot;</span>
        <span class="n">spec_comp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">species</span>
            <span class="n">spec_comp</span><span class="p">[</span><span class="n">spec</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec_comp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">atom</span><span class="o">.</span><span class="n">occupancy</span>
        <span class="k">return</span> <span class="n">spec_comp</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.name"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Unformatted name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">format_comp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">html_comp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">)</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.unit_comp"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.unit_comp">[docs]</a>    <span class="k">def</span> <span class="nf">unit_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Composition dict, where sum(self.unit_comp.values()) == 1&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">unit_comp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;numpy.ndarray of atom coordinates of shape (3, natoms).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">coord</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="p">])</span>

    <span class="nd">@coords.setter</span>
<div class="viewcode-block" id="Structure.coords"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.coords">[docs]</a>    <span class="k">def</span> <span class="nf">coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">c</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">%=</span> <span class="mf">1.0</span>
            <span class="n">c</span> <span class="o">%=</span> <span class="mf">1.0</span>
            <span class="n">a</span><span class="o">.</span><span class="n">coord</span> <span class="o">=</span> <span class="n">c</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">magmoms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;numpy.ndarray of magnetic moments of shape (natoms,).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">atom</span><span class="o">.</span><span class="n">magmom</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="p">])</span>

    <span class="nd">@magmoms.setter</span>
<div class="viewcode-block" id="Structure.magmoms"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.magmoms">[docs]</a>    <span class="k">def</span> <span class="nf">magmoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moms</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">mom</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moms</span><span class="p">):</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">magmom</span> <span class="o">=</span> <span class="n">mom</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.site_coords"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.site_coords">[docs]</a>    <span class="k">def</span> <span class="nf">site_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;numpy.ndarray of site coordinates of shape (3, nsites).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span> <span class="n">s</span><span class="o">.</span><span class="n">coord</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="p">])</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.site_labels"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.site_labels">[docs]</a>    <span class="k">def</span> <span class="nf">site_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Labels for all sites. For sites with single occupancy returns the</span>
<span class="sd">        atomic symbol, for sites with multiple occupancies returns &quot;(A,B)&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">s</span><span class="o">.</span><span class="n">label</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="p">])</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.cartesian_coords"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.cartesian_coords">[docs]</a>    <span class="k">def</span> <span class="nf">cartesian_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return atomic positions in cartesian coordinates.&quot;&quot;&quot;</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">direct</span><span class="p">:</span>
                <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">coord</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">coord</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">forces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;numpy.ndarray of forces on atoms.&quot;&quot;&quot;</span>
        <span class="n">forces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">forces</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">forces</span><span class="p">)</span>

    <span class="nd">@forces.setter</span>
<div class="viewcode-block" id="Structure.forces"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.forces">[docs]</a>    <span class="k">def</span> <span class="nf">forces</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forces</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">forces</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">forces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">forces</span> <span class="o">=</span> <span class="n">force</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.reciprocal_lattice"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.reciprocal_lattice">[docs]</a>    <span class="k">def</span> <span class="nf">reciprocal_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reciprocal lattice of the structure.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reciprocal_lattice</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reciprocal_lattice</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reciprocal_lattice</span>
</div>
    <span class="n">_inv</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.inv"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.inv">[docs]</a>    <span class="k">def</span> <span class="nf">inv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Precalculates the inverse of the lattice, for faster conversion</span>
<span class="sd">        between cartesian and direct coordinates.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inv</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inv</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">relative_rec_lat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rec_lat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span>
        <span class="n">rec_mags</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">norm</span><span class="p">,</span> <span class="n">rec_lat</span><span class="p">)</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rec_mags</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">r0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rec_mags</span> <span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_kpoint_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kppra</span><span class="p">):</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reciprocal_lattice</span>
        <span class="n">rec_mags</span> <span class="o">=</span> <span class="p">[</span> <span class="n">norm</span><span class="p">(</span><span class="n">recs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">norm</span><span class="p">(</span><span class="n">recs</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">norm</span><span class="p">(</span><span class="n">recs</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
        <span class="n">r0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rec_mags</span><span class="p">)</span>
        <span class="n">refr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">r0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rec_mags</span> <span class="p">])</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">kpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">kpts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">kppra</span><span class="p">:</span>
            <span class="n">prev_kpts</span> <span class="o">=</span> <span class="n">kpts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">refk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">refr</span><span class="p">)</span><span class="o">*</span><span class="n">scale</span>
            <span class="n">kpts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">,</span> <span class="n">refk</span><span class="p">))</span>
            <span class="n">scale</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">upper</span> <span class="o">=</span> <span class="n">kppra</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">prev_kpts</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">kpts</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span> <span class="o">-</span> <span class="n">kppra</span>
        <span class="k">if</span> <span class="n">upper</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">:</span>
            <span class="n">kpts</span> <span class="o">=</span> <span class="n">prev_kpts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">kpts</span>

    <span class="n">_mrd</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">minimum_repeat_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mrd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mrd</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat_params</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mrd</span>

<div class="viewcode-block" id="Structure.copy"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a complete copy of the structure, with any primary keys</span>
<span class="sd">        removed, so it is not associated with the original.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">new</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">atom_set</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">new_atom</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_atom</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">atom_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_atom</span><span class="p">)</span>
        <span class="n">new</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">atom_set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span><span class="p">:</span>
            <span class="n">new</span><span class="o">.</span><span class="n">get_sites</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">similar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Structure</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">natoms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">natoms</span><span class="p">,</span>
                <span class="n">composition</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="p">,</span> 
                <span class="n">spacegroup</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spacegroup</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<div class="viewcode-block" id="Structure.set_natoms"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.set_natoms">[docs]</a>    <span class="k">def</span> <span class="nf">set_natoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set self.atoms to n blank Atoms.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span> <span class="n">Atom</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">]</span>
</div>
<div class="viewcode-block" id="Structure.make_conventional"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.make_conventional">[docs]</a>    <span class="k">def</span> <span class="nf">make_conventional</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Uses spglib to convert to the conventional cell.</span>
<span class="sd">        </span>
<span class="sd">        .. warning:: </span>
<span class="sd">            Does not handle partial occupancy. If the cell is partially</span>
<span class="sd">            occupied, it is returned as is.</span>

<span class="sd">        Examples::</span>

<span class="sd">            &gt;&gt;&gt; s = io.read(INSTALL_PATH+&#39;io/files/POSCAR_FCC_prim&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print len(s)</span>
<span class="sd">            1</span>
<span class="sd">            &gt;&gt;&gt; s.make_conventional()</span>
<span class="sd">            &gt;&gt;&gt; print len(s)</span>
<span class="sd">            4</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">refine_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">()</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v1</span> <span class="o">-</span> <span class="n">v0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">StructureError</span><span class="p">(</span><span class="s">&#39;Volume changed: </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Structure.make_primitive"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.make_primitive">[docs]</a>    <span class="k">def</span> <span class="nf">make_primitive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Uses spglib to convert to the primitive cell.</span>
<span class="sd">        </span>
<span class="sd">        .. warning:: </span>
<span class="sd">            Does not handle partial occupancy. If the cell is partially</span>
<span class="sd">            occupied, it is returned as is.</span>

<span class="sd">        Examples::</span>

<span class="sd">            &gt;&gt;&gt; s = io.read(INSTALL_PATH+&#39;io/files/POSCAR_FCC&#39;)</span>
<span class="sd">            &gt;&gt;&gt; print len(s)</span>
<span class="sd">            4</span>
<span class="sd">            &gt;&gt;&gt; s.make_primitive()</span>
<span class="sd">            &gt;&gt;&gt; print len(s)</span>
<span class="sd">            1</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span> <span class="n">a</span><span class="o">.</span><span class="n">occupancy</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span> <span class="p">):</span>
            <span class="k">return</span>
        <span class="n">find_primitive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Structure.get_sites"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.get_sites">[docs]</a>    <span class="k">def</span> <span class="nf">get_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        From self.atoms, creates a list of Sites. Atoms which are closer</span>
<span class="sd">        than tol from one another are considered on the same site.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span> <span class="n">a</span><span class="o">.</span><span class="n">occupancy</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span> <span class="o">=</span> <span class="p">[</span> <span class="n">a</span><span class="o">.</span><span class="n">as_site</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span>
        <span class="n">d_sites</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">d_sites</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">is_on</span><span class="p">(</span><span class="n">site</span><span class="p">):</span>
                    <span class="n">site</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">site</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">as_site</span><span class="p">()</span>
                <span class="n">site</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="n">d_sites</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span> <span class="o">=</span> <span class="n">d_sites</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sites</span>
</div>
<div class="viewcode-block" id="Structure.group_atoms_by_symmetry"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.group_atoms_by_symmetry">[docs]</a>    <span class="k">def</span> <span class="nf">group_atoms_by_symmetry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sort self.atoms according to the site they occupy.&quot;&quot;&quot;</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">get_symmetry_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">)[</span><span class="s">&#39;equivalent_atoms&#39;</span><span class="p">]</span>
        <span class="n">resort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">eq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="p">)[</span><span class="n">resort</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="Structure.is_buerger_cell"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.is_buerger_cell">[docs]</a>    <span class="k">def</span> <span class="nf">is_buerger_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests whether or not the structure is a Buerger cell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrical_matrix</span>
        <span class="k">if</span> <span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">G</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tol</span> <span class="ow">or</span> <span class="n">G</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">G</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">G</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">G</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">G</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Structure.is_niggli_cell"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.is_niggli_cell">[docs]</a>    <span class="k">def</span> <span class="nf">is_niggli_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests whether or not the structure is a Niggli cell.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_grueber_cell</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">),(</span><span class="n">d</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">f</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">niggli_form</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">e</span> <span class="o">-</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">d</span> <span class="o">-</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">d</span> <span class="o">-</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">e</span><span class="o">+</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="o">+</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="n">e</span><span class="o">+</span><span class="n">f</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">e</span><span class="o">+</span><span class="n">f</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">tol</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
    <span class="k">def</span> <span class="nf">find_nearest_neighbors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_neighbor_dict</span> <span class="o">=</span> <span class="n">find_closest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span>

    <span class="n">_neighbor_dict</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nearest_neighbor_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neighbor_dict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_nearest_neighbors</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_neighbor_dict</span>

    <span class="k">def</span> <span class="nf">get_sublattice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">elements</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">new</span><span class="p">:</span>
            <span class="n">struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">get_sublattice</span><span class="p">(</span><span class="n">elements</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span> <span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">element_id</span> <span class="ow">in</span> <span class="n">elements</span> <span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="Structure.get_spin_lattice"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.get_spin_lattice">[docs]</a>    <span class="k">def</span> <span class="nf">get_spin_lattice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elements</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">supercell</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a lattice of sites.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            elements:</span>
<span class="sd">                If `elements` is supplied, get_spin_lattice will return the </span>
<span class="sd">                lattice of those elements only. </span>

<span class="sd">            supercell:</span>
<span class="sd">                Accepts any valid input to Structure.transform to construct a</span>
<span class="sd">                supercell, and return its lattice. Useful for finding AFM</span>
<span class="sd">                orderings for structures which have a smaller periodicity than</span>
<span class="sd">                their magnetic structure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A SpinLattice, which is a container for a lattice graph, which</span>
<span class="sd">            contains nodes which are atoms and edges which indicate nearest</span>
<span class="sd">            neighbors.</span>

<span class="sd">        Examples::</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; s = io.read(INSTALL_PATH+&#39;/io/files/fe3o4.cif&#39;)</span>
<span class="sd">            &gt;&gt;&gt; spin_lattice = s.get_spin_lattice(elements=[&#39;Fe&#39;])</span>
<span class="sd">            &gt;&gt;&gt; sl.set_fraction(0.33333)</span>
<span class="sd">            &gt;&gt;&gt; sl.fraction</span>
<span class="sd">            0.3333333333333333</span>
<span class="sd">            &gt;&gt;&gt; sl.run_MC()</span>
<span class="sd">            &gt;&gt;&gt; sl.up_spins</span>
<span class="sd">            [&lt;Atom: Fe @ 0.5 0.0 0.0&gt;, </span>
<span class="sd">             &lt;Atom: Fe @ 0.0 0.5 0.0&gt;, </span>
<span class="sd">             &lt;Atom: Fe @ 0.0 0.0 0.5&gt;, </span>
<span class="sd">             &lt;Atom: Fe @ 0.5 0.5 0.5&gt;]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">supercell</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">supercell</span><span class="p">)</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">elements</span><span class="p">:</span>
            <span class="n">struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sublattice</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">get_spin_lattice</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_nearest_neighbors</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">a1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">a1</span><span class="o">.</span><span class="n">neighbors</span><span class="p">:</span>
                <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">])</span>

        <span class="n">lattice</span> <span class="o">=</span> <span class="n">SpinLattice</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lattice</span>
</div>
    <span class="k">def</span> <span class="nf">displace_atom</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vector</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Provide a 3x1 translation array&#39;</span><span class="p">)</span>

        <span class="n">structure</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">coord</span> <span class="o">+=</span> <span class="n">vector</span>
        <span class="k">return</span> <span class="n">structure</span>

<div class="viewcode-block" id="Structure.joggle_atoms"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.joggle_atoms">[docs]</a>    <span class="k">def</span> <span class="nf">joggle_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Randomly displace all atoms in each direction by a distance up to +/- the</span>
<span class="sd">        distance keyword argument.</span>

<span class="sd">        Optional keyword arguments:</span>
<span class="sd">            *distance*      : Range within all internal coordinates are</span>
<span class="sd">                                displaced. Default=1e-3</span>
<span class="sd">            *in_place*      : If True, returns an ndarray of the applied</span>
<span class="sd">                                translations. If False, returns (Structure,</span>
<span class="sd">                                translations).</span>

<span class="sd">        Examples::</span>

<span class="sd">            &gt;&gt;&gt; s = io.read(&#39;POSCAR&#39;)</span>
<span class="sd">            &gt;&gt;&gt; s2, trans = s.joggle_atoms(in_place=False)</span>
<span class="sd">            &gt;&gt;&gt; trans = s.joggle_atoms(1e-1)</span>
<span class="sd">            &gt;&gt;&gt; trans = s.joggle_atoms(distance=1e-1)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new</span><span class="o">.</span><span class="n">joggle_atoms</span><span class="p">(</span><span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new</span>

        <span class="k">def</span> <span class="nf">disp</span><span class="p">():</span>
            <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lp</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span><span class="o">*</span><span class="n">distance</span>
            <span class="n">rands</span> <span class="o">=</span> <span class="p">[</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">]</span>
            <span class="k">return</span> <span class="n">dists</span><span class="o">*</span><span class="n">rands</span>

        <span class="n">translations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coords</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">tvec</span> <span class="o">=</span> <span class="n">disp</span><span class="p">()</span>
            <span class="n">translations</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">tvec</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">coord</span> <span class="o">+=</span> <span class="n">tvec</span>
        <span class="k">return</span> <span class="n">translations</span>
</div>
<div class="viewcode-block" id="Structure.recenter"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.recenter">[docs]</a>    <span class="k">def</span> <span class="nf">recenter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Translate the internal coordinates to center the specified atom. Atom</span>
<span class="sd">        can be an actual Atom from the Structure.atoms list, or can be</span>
<span class="sd">        identified by index.</span>

<span class="sd">        Optional keyword arguments:</span>
<span class="sd">            *in_place*  : If False, return a new Structure with the</span>
<span class="sd">                            transformation applied.</span>

<span class="sd">        Examples::</span>

<span class="sd">            &gt;&gt;&gt; s = io.read(&#39;POSCAR&#39;)</span>
<span class="sd">            &gt;&gt;&gt; s.recenter(s[2])</span>
<span class="sd">            &gt;&gt;&gt; s2 = s.recenter(s[0], in_place=False)</span>
<span class="sd">            &gt;&gt;&gt; s2.recenter(2)</span>
<span class="sd">            &gt;&gt;&gt; s == s2</span>
<span class="sd">            True</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new</span><span class="o">.</span><span class="n">recenter</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="n">structure</span><span class="p">[</span><span class="n">atom</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="o">-</span><span class="n">atom</span><span class="o">.</span><span class="n">coord</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">cartesian</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Structure.translate"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.translate">[docs]</a>    <span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cv</span><span class="p">,</span> <span class="n">cartesian</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shifts the contents of the structure by a vector. </span>

<span class="sd">        Optional keyword arguments:</span>
<span class="sd">            *cartesian*     : If True, translation vector is taken to be</span>
<span class="sd">                                cartesian coordinates. If False, translation</span>
<span class="sd">                                vector is taken to be in fractional</span>
<span class="sd">                                coordinates. Default=True</span>
<span class="sd">            *in_place*      : If False, return a new Structure with the</span>
<span class="sd">                                transformation applied.</span>

<span class="sd">        Examples::</span>

<span class="sd">            &gt;&gt;&gt; s = io.read(&#39;POSCAR&#39;)</span>
<span class="sd">            &gt;&gt;&gt; s.translate([1,2,3])</span>
<span class="sd">            &gt;&gt;&gt; s.translate([0.5,0.5, 0.5], cartesian=False)</span>
<span class="sd">            &gt;&gt;&gt; s2 = s.translate([-1,2,1], in_place=False)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="n">cartesian</span><span class="o">=</span><span class="n">cartesian</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new</span>

        <span class="n">cv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cv</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cv</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cv</span><span class="p">]):</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">cartesian</span><span class="p">:</span>
            <span class="n">cv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cv</span><span class="p">)))</span>

        <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">+</span> <span class="n">cv</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">%</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span> <span class="o">%</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="Structure.transform"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply lattice transform to the structure. Accepts transformations of</span>
<span class="sd">        shape (3,) and (3,3).</span>
<span class="sd">        </span>
<span class="sd">        Optional keyword arguments:</span>
<span class="sd">            *in_place*      : If False, return a new Structure with the</span>
<span class="sd">                                transformation applied.</span>

<span class="sd">        Examples::</span>

<span class="sd">            &gt;&gt;&gt; s = io.read(&#39;POSCAR&#39;)</span>
<span class="sd">            &gt;&gt;&gt; s.transform([2,2,2]) # 2x2x2 supercell</span>
<span class="sd">            &gt;&gt;&gt; s.transform([[0,1,0],[1,0,0],[0,0,1]]) # swap axis 1 for 2</span>
<span class="sd">            &gt;&gt;&gt; s2 = s.transform([2,2,2], in_place=False)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new</span>

        <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transform</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">transform</span><span class="o">.</span><span class="n">shape</span> <span class="ow">in</span> <span class="p">[</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span> <span class="p">]:</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">transform</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="k">if</span> <span class="n">la</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># if cell size doesn&#39;t change</span>
            <span class="n">new_cell</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">inv</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="p">])</span>
            <span class="n">coords</span> <span class="o">%=</span> <span class="mf">1.0</span>
            <span class="n">coords</span> <span class="o">%=</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">new_cell</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="c"># construct the new lattice</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">new_cell</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

        <span class="c"># fill with atoms</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cartesian_coords</span><span class="p">)</span>
        <span class="n">elts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">)</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">transform</span><span class="p">[:,</span><span class="n">i</span><span class="p">])))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="p">]</span> 
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">limits</span> <span class="p">]</span>
        <span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span> <span class="n">basis</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ijk</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span> <span class="k">for</span> <span class="n">ijk</span> <span class="ow">in</span>
                            <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">ranges</span><span class="p">)])</span>
        <span class="n">tmp_elts</span> <span class="o">=</span> <span class="n">elts</span><span class="o">*</span><span class="n">n_cells</span>

        <span class="c"># remove atoms not in lattice</span>
        <span class="n">cell_inv</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">new_cell</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">new_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">new_elts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">elt</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tmp_elts</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">roundclose</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cell_inv</span><span class="p">,</span> <span class="n">coord</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([(</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coord</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="n">new_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
            <span class="n">new_elts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>
        <span class="n">new_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_coords</span><span class="p">)</span>

        <span class="n">new_coords</span> <span class="o">%=</span> <span class="mf">1.0</span>
        <span class="n">new_coords</span> <span class="o">%=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_natoms</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_coords</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">new_coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span> <span class="o">=</span> <span class="n">new_elts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">new_cell</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="Structure.substitute"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.substitute">[docs]</a>    <span class="k">def</span> <span class="nf">substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replace</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace atoms, as specified in a dict of pairs. </span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            rescale: </span>
<span class="sd">                rescale the volume of the final structure based on the per </span>
<span class="sd">                atom volume of the new composition.</span>

<span class="sd">            in_place: </span>
<span class="sd">                change the species of the current Structure or return a new </span>
<span class="sd">                one.</span>

<span class="sd">        Examples::</span>

<span class="sd">            &gt;&gt;&gt; s = io.read(&#39;POSCAR-Fe2O3&#39;)</span>
<span class="sd">            &gt;&gt;&gt; s2 = s.substitute({&#39;Fe&#39;:&#39;Ni&#39;, &#39;O&#39;:&#39;F&#39;} rescale=True)</span>
<span class="sd">            &gt;&gt;&gt; s2.substitute({&#39;Ni&#39;:&#39;Co&#39;}, in_place=True, rescale=False)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">replace</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new</span>

        <span class="n">volume</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element_id</span> <span class="ow">in</span> <span class="n">replace</span><span class="p">:</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">element_id</span> <span class="o">=</span> <span class="n">replace</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">element_id</span><span class="p">]</span>
            <span class="n">volume</span> <span class="o">+=</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">volume</span>
        <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_volume</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_composition</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="Structure.refine"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.refine">[docs]</a>    <span class="k">def</span> <span class="nf">refine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify atoms that are close to high symmetry sites (within `tol` and</span>
<span class="sd">        shift them onto them.</span>

<span class="sd">        Note: </span>
<span class="sd">            &quot;symprec&quot; doesn&#39;t appear to do anything with spglib, so I am</span>
<span class="sd">            unable to get &quot;loose&quot; symmetry operations. Without which, this </span>
<span class="sd">            doesn&#39;t work.</span>

<span class="sd">        Examples::</span>

<span class="sd">            &gt;&gt;&gt; s = io.read(&#39;POSCAR&#39;)</span>
<span class="sd">            &gt;&gt;&gt; s.symmetrize()</span>
<span class="sd">            &gt;&gt;&gt; print s.spacegroup</span>
<span class="sd">            225L</span>
<span class="sd">            &gt;&gt;&gt; s.refine()</span>
<span class="sd">            &gt;&gt;&gt; print s.spacegroup</span>
<span class="sd">            1L</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reduce</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="mf">1.0</span><span class="o">*</span><span class="n">tol</span><span class="p">)</span>
        <span class="n">new_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">rot</span><span class="p">,</span> <span class="n">trans</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">rot</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">coord</span><span class="p">)</span> <span class="o">+</span> <span class="n">trans</span>
                <span class="n">test</span> <span class="o">%=</span> <span class="mf">1.0</span>
                <span class="n">cart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">la</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cart</span><span class="o">-</span><span class="n">atom</span><span class="o">.</span><span class="n">cart_coord</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">cart</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">]):</span>
                        <span class="n">coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>
            <span class="n">central</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">new_coords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">central</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">new_coords</span>
        <span class="k">if</span> <span class="n">recurse</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">refine</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">recurse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Structure.reduce"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the transformation matrix from unit to reduced cell</span>
<span class="sd">        Acta. Cryst. (1976) A32, 297</span>
<span class="sd">        Acta. Cryst. (2003) A60, 1</span>

<span class="sd">        Optional keyword arguments:</span>
<span class="sd">            *tol* : </span>
<span class="sd">                eps_rel in Acta. Cryst. 2003 above. Similar to </span>
<span class="sd">                tolerance for floating point comparisons. Defaults to 1e-5.</span>
<span class="sd">            *limit* : </span>
<span class="sd">                maximum number of loops through the algorithm. Defaults to </span>
<span class="sd">                1000. </span>
<span class="sd">            *in_place* : </span>
<span class="sd">                Change the Structure or return a new one. If True, the </span>
<span class="sd">                transformation matrix is returned. If False, a tuple of</span>
<span class="sd">                (Structure, transformation_matrix) is returned. </span>

<span class="sd">        Examples::</span>

<span class="sd">            &gt;&gt;&gt; s = io.read(&#39;POSCAR&#39;)</span>
<span class="sd">            &gt;&gt;&gt; s.reduce()</span>
<span class="sd">            &gt;&gt;&gt; s.reduce(in_place=False, get_transform=False)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">reduction</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new</span><span class="p">,</span> <span class="n">trans</span>

        <span class="c"># reduction parameters</span>
        <span class="n">vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">),</span> <span class="p">(</span><span class="n">ksi</span><span class="p">,</span><span class="n">eta</span><span class="p">,</span><span class="n">zeta</span><span class="p">)</span> <span class="o">=</span> <span class="n">basis_to_niggli</span><span class="p">(</span><span class="n">vectors</span><span class="p">)</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c"># convergence variables</span>
        <span class="n">_a</span><span class="p">,</span> <span class="n">_b</span><span class="p">,</span> <span class="n">_c</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">b</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">c</span><span class="o">*</span><span class="mi">10</span>
        <span class="n">mult</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="c"># tolerance and tests</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">tol</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volume</span><span class="p">()</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">lt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="o">-</span> <span class="n">eps</span>

        <span class="k">def</span> <span class="nf">gt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span> <span class="o">+</span> <span class="n">eps</span>

        <span class="k">def</span> <span class="nf">eq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">eps</span>

        <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">trans</span><span class="p">):</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">basis_to_niggli</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vectors</span><span class="p">)),</span> <span class="n">trans</span>

        <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">step</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c"># N 1</span>
            <span class="k">if</span> <span class="n">gt</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ksi</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="n">eta</span><span class="p">))):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">),(</span><span class="n">ksi</span><span class="p">,</span><span class="n">eta</span><span class="p">,</span><span class="n">zeta</span><span class="p">)),</span><span class="n">trans</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;reduction: test 1&#39;</span><span class="p">)</span>

            <span class="c"># N 2</span>
            <span class="k">if</span> <span class="n">gt</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span> <span class="n">eq</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eta</span><span class="p">),</span><span class="nb">abs</span><span class="p">(</span><span class="n">zeta</span><span class="p">))):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]])</span>
                <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">),(</span><span class="n">ksi</span><span class="p">,</span><span class="n">eta</span><span class="p">,</span><span class="n">zeta</span><span class="p">)),</span><span class="n">trans</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;reduction: test 2&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c"># N 3</span>
            <span class="k">if</span> <span class="n">gt</span><span class="p">(</span><span class="n">ksi</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span><span class="n">zeta</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="p">(</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">lt</span><span class="p">(</span><span class="n">ksi</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span> <span class="p">)</span>
                <span class="n">j</span> <span class="o">=</span> <span class="p">(</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">lt</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span> <span class="p">)</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">lt</span><span class="p">(</span><span class="n">zeta</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span> <span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>
                <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">),(</span><span class="n">ksi</span><span class="p">,</span><span class="n">eta</span><span class="p">,</span><span class="n">zeta</span><span class="p">)),</span><span class="n">trans</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;reduction: test 3 True path&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">p</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">ksi</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zeta</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">gt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">lt</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">vals</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">vals</span>
                <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">),(</span><span class="n">ksi</span><span class="p">,</span><span class="n">eta</span><span class="p">,</span><span class="n">zeta</span><span class="p">)),</span><span class="n">trans</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;reduction: test 3 False path&#39;</span><span class="p">)</span>

                <span class="c"># test minimum reduction</span>
            <span class="k">if</span> <span class="p">(</span> <span class="n">mult</span><span class="o">*</span><span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">_a</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">mult</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> 
                    <span class="ow">and</span> 
                 <span class="n">mult</span><span class="o">*</span><span class="n">b</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">_b</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">mult</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="ow">and</span> 
                 <span class="n">mult</span><span class="o">*</span><span class="n">c</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">_c</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">mult</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;reduction: Minimum reduction test passed&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">_a</span><span class="p">,</span> <span class="n">_b</span><span class="p">,</span> <span class="n">_c</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span>

            <span class="c"># N 5</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ksi</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">ksi</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">eta</span><span class="p">,</span><span class="n">zeta</span><span class="p">))</span> <span class="ow">or</span> 
                    <span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">ksi</span><span class="p">,</span><span class="o">-</span><span class="n">b</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lt</span><span class="p">(</span><span class="n">zeta</span><span class="p">,</span><span class="mi">0</span><span class="p">))):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">sign</span><span class="p">(</span><span class="n">ksi</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
                <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">),(</span><span class="n">ksi</span><span class="p">,</span><span class="n">eta</span><span class="p">,</span><span class="n">zeta</span><span class="p">)),</span><span class="n">trans</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;reduction: test 5&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c"># N 6</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eta</span><span class="p">),</span><span class="n">a</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="p">(</span> <span class="n">eq</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ksi</span><span class="p">,</span><span class="n">zeta</span><span class="p">))</span> <span class="ow">or</span> 
                    <span class="p">(</span> <span class="n">eq</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lt</span><span class="p">(</span><span class="n">zeta</span><span class="p">,</span><span class="mi">0</span><span class="p">))):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">sign</span><span class="p">(</span><span class="n">eta</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
                <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">),(</span><span class="n">ksi</span><span class="p">,</span><span class="n">eta</span><span class="p">,</span><span class="n">zeta</span><span class="p">)),</span><span class="n">trans</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;reduction: test 6&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            
            <span class="c"># N 7</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">zeta</span><span class="p">),</span><span class="n">a</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="p">(</span> <span class="n">eq</span><span class="p">(</span><span class="n">zeta</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ksi</span><span class="p">,</span> <span class="n">eta</span><span class="p">))</span> <span class="ow">or</span> 
                    <span class="p">(</span> <span class="n">eq</span><span class="p">(</span><span class="n">zeta</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lt</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="mi">0</span><span class="p">))):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="n">sign</span><span class="p">(</span><span class="n">zeta</span><span class="p">),</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
                <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">),(</span><span class="n">ksi</span><span class="p">,</span><span class="n">eta</span><span class="p">,</span><span class="n">zeta</span><span class="p">)),</span><span class="n">trans</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;reduction: test 7&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c"># N 8</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">lt</span><span class="p">(</span><span class="n">ksi</span> <span class="o">+</span> <span class="n">eta</span> <span class="o">+</span> <span class="n">zeta</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> 
                    <span class="p">(</span><span class="n">eq</span><span class="p">(</span><span class="n">ksi</span> <span class="o">+</span> <span class="n">eta</span> <span class="o">+</span> <span class="n">zeta</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">eta</span><span class="p">)</span><span class="o">+</span><span class="n">zeta</span><span class="p">,</span> <span class="mi">0</span><span class="p">))):</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>
                <span class="p">((</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">),(</span><span class="n">ksi</span><span class="p">,</span><span class="n">eta</span><span class="p">,</span><span class="n">zeta</span><span class="p">)),</span><span class="n">trans</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">trans</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;reduction: test 8&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">break</span>

        <span class="c"># temporarily stored transformations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_original_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unit_to_reduced</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reduced_point_to_unit</span> <span class="o">=</span> <span class="n">trans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unit_point_to_reduced</span> <span class="o">=</span> <span class="n">la</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">trans</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">trans</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trans</span>
</div>
    <span class="k">def</span> <span class="nf">get_xrd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">xrd</span> <span class="o">=</span> <span class="n">XRD</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">xrd</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()</span>
        <span class="n">xrd</span><span class="o">.</span><span class="n">get_intensities</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">xrd</span>

    <span class="k">def</span> <span class="nf">get_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_pdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Structure.get_perfect_structure"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Structure.get_perfect_structure">[docs]</a>    <span class="k">def</span> <span class="nf">get_perfect_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_place</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs options for a &#39;perfect&#39; lattice from the structure.</span>

<span class="sd">        If a site is not fully occupied, but has only one atom type on it, it</span>
<span class="sd">        will be filled the rest of the way.</span>
<span class="sd">        If a site has two or more atom types on it, the higher fraction element</span>
<span class="sd">        will fill the site. If the site is equally filled, the higher structure</span>
<span class="sd">        fraction element will fill the site. If the structure is equal between</span>
<span class="sd">        atom types, options will be returned for each atom type.</span>

<span class="sd">        Keyword Arguments:</span>
<span class="sd">            in_place: If False returns a new :mod:`~qmpy.Structure`, otherwise</span>
<span class="sd">            returns None</span>

<span class="sd">        Examples::</span>
<span class="sd">            </span>
<span class="sd">            &gt;&gt;&gt; s = io.read(INSTALL_PATH+&#39;/io/files/partial_vac.cif&#39;)</span>
<span class="sd">            &gt;&gt;&gt; s</span>
<span class="sd">            &lt;Structure: Mn3.356Si4O16&gt;</span>
<span class="sd">            &gt;&gt;&gt; s.get_perfect_structure(in_place=True)</span>
<span class="sd">            &gt;&gt;&gt; s</span>
<span class="sd">            &lt;Structure: MnSiO4&gt;</span>
<span class="sd">            &gt;&gt;&gt; s = io.read(INSTALL_PATH+&#39;/io/files/partial_mix.cif&#39;)</span>
<span class="sd">            &gt;&gt;&gt; s</span>
<span class="sd">            &lt;Structure: Mn4.264Co3.736Si4O16&gt;</span>
<span class="sd">            &gt;&gt;&gt; s.get_perfect_structure(True)</span>
<span class="sd">            &gt;&gt;&gt; s</span>
<span class="sd">            &lt;Structure: MnCoSiO4&gt;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">new</span><span class="o">.</span><span class="n">get_perfect_structure</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">site</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">site</span><span class="o">.</span><span class="n">occupancy</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">site</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">a</span><span class="o">.</span><span class="n">occupancy</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">site</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">dom</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">occs</span> <span class="o">=</span> <span class="p">[</span> <span class="n">a</span><span class="o">.</span><span class="n">occupancy</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">site</span> <span class="p">]</span>
                <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit_comp</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">element_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">site</span> <span class="p">]</span>
                <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">occs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">occs</span><span class="p">):</span>
                    <span class="n">dom</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">occupancy</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">max</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">min</span><span class="p">(</span><span class="n">comps</span><span class="p">):</span>
                    <span class="n">dom</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">element_id</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                    <span class="c">#atoms += site.atoms</span>

                <span class="n">dom</span><span class="o">.</span><span class="n">occupancy</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dom</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">last_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">=</span> <span class="n">Composition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_sites</span><span class="p">()</span>
        <span class="c"># test for too close atoms</span>
        <span class="n">dists</span> <span class="o">=</span> <span class="n">get_pair_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">dists</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">bl</span> <span class="o">=</span> <span class="p">[</span> <span class="n">elements</span><span class="p">[</span><span class="n">elt</span><span class="p">][</span><span class="s">&#39;atomic_radii&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">100</span> <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">k</span> <span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">bl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">bl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">*</span><span class="mf">1.3333</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Cannot fill sites.&quot;</span><span class="p">)</span>
                <span class="n">k</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                <span class="k">print</span> <span class="s">&#39;bond length should be&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                <span class="k">print</span> <span class="s">&#39;was found to be&#39;</span><span class="p">,</span> <span class="n">d</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">last_atoms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">composition</span> <span class="o">=</span> <span class="n">Composition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_sites</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="bp">self</span>
</div></div>
<div class="viewcode-block" id="Prototype"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Prototype">[docs]</a><span class="k">class</span> <span class="nc">Prototype</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for a prototype structure. </span>

<span class="sd">    Relationships:</span>
<span class="sd">        | :mod:`~qmpy.Composition` via composition_set</span>
<span class="sd">        | :mod:`~qmpy.Structure` via structure_set</span>
<span class="sd">        | :mod:`~qmpy.Entry` via entry_set</span>

<span class="sd">    Attributes:</span>
<span class="sd">        | name: Prototype name.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">63</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">structure</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Structure</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;+&#39;</span><span class="p">,</span> 
                                  <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">composition</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;Composition&#39;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">app_label</span> <span class="o">=</span> <span class="s">&#39;qmpy&#39;</span>
        <span class="n">db_table</span> <span class="o">=</span> <span class="s">&#39;prototypes&#39;</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Prototype.get"><a class="viewcode-back" href="../../../models.html#qmpy.materials.structure.Prototype.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves a :ref:`Prototype` named `name` if it exists. If not, creates</span>
<span class="sd">        a new one.</span>

<span class="sd">        Examples:</span>

<span class="sd">          &gt;&gt;&gt; proto = Prototype.get(&#39;Corundum&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">qmpy 0.4.9 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../qmpy.html" >qmpy</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Scott Kirklin.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>